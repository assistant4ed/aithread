generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Workspace {
  id                    String               @id @default(cuid())
  name                  String               @unique
  isActive              Boolean              @default(true)
  targetAccounts        String[]
  translationPrompt     String
  hotScoreThreshold     Float                @default(50)
  threadsAppId          String?
  threadsToken          String?
  dailyPostLimit        Int                  @default(3)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  maxPostAgeHours       Int                  @default(48)
  publishTimes          String[]             @default(["12:00", "18:00", "22:00"])
  reviewWindowHours     Int                  @default(1)
  synthesisLanguage     String               @default("Traditional Chinese (HK/TW)")
  topicFilter           String?
  lastPublishedAt       DateTime?
  lastScrapedAt         DateTime?
  lastSynthesizedAt     DateTime?
  clusteringPrompt      String               @default("Group these posts into news clusters. Focus on the core event or announcement. Combine posts from different authors if they are about the SAME story. Ignore generic chatter.")
  postLookbackHours     Int                  @default(24)
  instagramAccessToken  String?
  instagramAccountId    String?
  twitterAccessSecret   String?
  twitterAccessToken    String?
  twitterApiKey         String?
  twitterApiSecret      String?
  instagramExpiresAt    Int?
  instagramRefreshToken String?
  twitterExpiresAt      Int?
  twitterRefreshToken   String?
  threadsExpiresAt      Int?
  threadsRefreshToken   String?
  posts                 Post[]
  articles              SynthesizedArticle[]
}

model Post {
  id                 String          @id @default(cuid())
  threadId           String          @unique
  sourceAccount      String
  contentOriginal    String?
  contentTranslated  String?
  mediaUrls          Json?
  likes              Int             @default(0)
  replies            Int             @default(0)
  reposts            Int             @default(0)
  hotScore           Float           @default(0)
  sourceUrl          String?
  status             PostStatus      @default(PENDING_REVIEW)
  publishedUrl       String?
  coherenceStatus    CoherenceStatus @default(PENDING)
  topicClusterId     String?
  lastCoherenceCheck DateTime?
  workspaceId        String
  createdAt          DateTime        @default(now())
  publishedAt        DateTime?
  postedAt           DateTime?
  views              Int             @default(0)
  externalUrls       String[]        @default([])
  workspace          Workspace       @relation(fields: [workspaceId], references: [id])
}

model TrackedAccount {
  username      String   @id
  followerCount Int      @default(0)
  lastFetchedAt DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SynthesizedArticle {
  id                    String     @id @default(cuid())
  topicName             String
  articleContent        String
  articleOriginal       String?
  sourcePostIds         String[]
  sourceAccounts        String[]
  authorCount           Int
  postCount             Int
  selectedMediaUrl      String?
  selectedMediaType     String?
  scheduledPublishAt    DateTime?
  workspaceId           String
  status                PostStatus @default(PENDING_REVIEW)
  publishedUrl          String?
  createdAt             DateTime   @default(now())
  publishedAt           DateTime?
  mediaUrls             Json[]     @default([])
  externalUrls          String[]   @default([])
  instagramMediaId      String?
  publishedAtInstagram  DateTime?
  publishedAtTwitter    DateTime?
  publishedUrlInstagram String?
  publishedUrlTwitter   String?
  tweetId               String?
  workspace             Workspace  @relation(fields: [workspaceId], references: [id])
}

enum PostStatus {
  PENDING_REVIEW
  APPROVED
  PUBLISHED
  REJECTED
  ERROR
}

enum CoherenceStatus {
  PENDING
  COHERENT
  ISOLATED
}
