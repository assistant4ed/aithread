generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Workspace {
  id                    String               @id @default(cuid())
  name                  String               @unique
  isActive              Boolean              @default(true)
  translationPrompt     String
  hotScoreThreshold     Float                @default(50)
  threadsAppId          String?
  threadsToken          String?
  dailyPostLimit        Int                  @default(3)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  maxPostAgeHours       Int                  @default(48)
  publishTimes          String[]             @default(["12:00", "18:00", "22:00"])
  reviewWindowHours     Int                  @default(1)
  synthesisLanguage     String               @default("Traditional Chinese (HK/TW)")
  topicFilter           String?
  lastPublishedAt       DateTime?
  lastScrapedAt         DateTime?
  lastSynthesizedAt     DateTime?
  clusteringPrompt      String               @default("Group these posts into news clusters. Focus on the core event or announcement. Combine posts from different authors if they are about the SAME story. Ignore generic chatter.")
  synthesisPrompt       String               @default("You are a viral social media editor. Synthesize these clustered social media posts into a high-impact, skimmable curated summary.")
  coherenceThreshold    Int                  @default(2)
  postLookbackHours     Int                  @default(24)
  instagramAccessToken  String?
  instagramAccountId    String?
  twitterAccessSecret   String?
  twitterAccessToken    String?
  twitterApiKey         String?
  twitterApiSecret      String?
  instagramExpiresAt    Int?
  instagramRefreshToken String?
  twitterExpiresAt      Int?
  twitterRefreshToken   String?
  threadsExpiresAt      Int?
  threadsRefreshToken   String?
  posts                 Post[]
  articles              SynthesizedArticle[]
  autoApproveDrafts     Boolean              @default(false)
  autoApprovePrompt     String?
  sources               ScraperSource[]
  pipelineRuns          PipelineRun[]

  // AI Configuration
  aiProvider            String               @default("GROQ")
  aiModel               String               @default("llama-3.3-70b-versatile")
  aiApiKey              String?              // Optional override

  ownerId               String?              // Nullable for migration
  owner                 User?                @relation(fields: [ownerId], references: [id])
}

model User {
  id            String          @id @default(cuid())
  name          String?
  email         String          @unique
  emailVerified DateTime?
  passwordHash  String?
  image         String?
  accounts      Account[]
  sessions      Session[]
  workspaces    Workspace[]
  youtubeJobs   YoutubeJob[]
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
 
model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@id([provider, providerAccountId])
}
 
model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
 
model VerificationToken {
  identifier String
  token      String
  expires    DateTime
 
  @@id([identifier, token])
}

model ScraperSource {
  id          String     @id @default(cuid())
  workspaceId String
  type        SourceType 
  value       String     
  platform    Platform
  isActive    Boolean    @default(true)

  minLikes    Int?       @default(50)
  minReplies  Int?       @default(0)
  maxAgeHours Int?       @default(24)

  trustWeight Float      @default(1.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])

  @@unique([workspaceId, type, value])
}

model Post {
  id                 String          @id @default(cuid())
  threadId           String          
  sourceAccount      String
  contentOriginal    String?
  contentTranslated  String?
  mediaUrls          Json?
  likes              Int             @default(0)
  replies            Int             @default(0)
  reposts            Int             @default(0)
  hotScore           Float           @default(0)
  sourceUrl          String?
  status             PostStatus      @default(PENDING_REVIEW)
  publishedUrl       String?
  coherenceStatus    CoherenceStatus @default(PENDING)
  topicClusterId     String?
  lastCoherenceCheck DateTime?
  workspaceId        String
  sourceId           String?
  sourceType         SourceType      @default(ACCOUNT)
  createdAt          DateTime        @default(now())
  publishedAt        DateTime?
  postedAt           DateTime?
  views              Int             @default(0)
  externalUrls       String[]        @default([])
  workspace          Workspace       @relation(fields: [workspaceId], references: [id])

  @@unique([threadId, workspaceId])
}

model TrackedAccount {
  username      String   @id
  followerCount Int      @default(0)
  lastFetchedAt DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SynthesizedArticle {
  id                    String     @id @default(cuid())
  topicName             String
  articleContent        String
  articleOriginal       String?
  sourcePostIds         String[]
  sourceAccounts        String[]
  authorCount           Int
  postCount             Int
  selectedMediaUrl      String?
  selectedMediaType     String?
  scheduledPublishAt    DateTime?
  workspaceId           String
  status                PostStatus @default(PENDING_REVIEW)
  publishedUrl          String?
  createdAt             DateTime   @default(now())
  publishedAt           DateTime?
  mediaUrls             Json[]     @default([])
  externalUrls          String[]   @default([])
  instagramMediaId      String?
  publishedAtInstagram  DateTime?
  publishedAtTwitter    DateTime?
  publishedUrlInstagram String?
  publishedUrlTwitter   String?
  threadsMediaId        String?
  tweetId               String?
  formatUsed            String?
  
  // Performance Metrics
  views                 Int        @default(0)
  likes                 Int        @default(0)
  replies               Int        @default(0)
  reposts               Int        @default(0)
  lastMetricsUpdate     DateTime?

  workspace             Workspace  @relation(fields: [workspaceId], references: [id])
}

enum PostStatus {
  PENDING_REVIEW
  APPROVED
  PUBLISHED
  REJECTED
  ERROR
}

enum CoherenceStatus {
  PENDING
  COHERENT
  ISOLATED
}

enum SourceType {
  ACCOUNT
  TOPIC
}

enum Platform {
  THREADS
  INSTAGRAM
  TWITTER
}

model AccountCache {
  id            String   @id @default(cuid())
  platformId    String
  platform      Platform
  followerCount Int
  updatedAt     DateTime @updatedAt

  @@unique([platformId, platform])
  @@index([platformId])
}

model ScrapeLog {
  id               String      @id @default(cuid())
  sourceId         String
  sourceType       SourceType
  pagesScraped     Int
  rawCollected     Int
  failedFreshness  Int
  failedEngagement Int
  unknownFollowers Int
  qualified        Int
  createdAt        DateTime    @default(now())

  @@index([sourceId])
}

model YoutubeJob {
  id             String    @id @default(cuid())
  videoId        String?
  videoUrl       String
  language       String
  status         JobStatus @default(PENDING)
  pdfUrl         String?
  oneLiner       String?
  error          String?
  requestedById  String
  requestedBy    User      @relation(fields: [requestedById], references: [id])
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([requestedById])
}

model PipelineRun {
  id          String       @id @default(cuid())
  workspaceId String
  step        PipelineStep
  status      RunStatus    @default(RUNNING)
  startedAt   DateTime     @default(now())
  completedAt DateTime?
  error       String?
  metadata    Json?        // e.g. { postsScraped: 42, jobsEnqueued: 5 }

  workspace   Workspace    @relation(fields: [workspaceId], references: [id])

  @@index([workspaceId, step])
  @@index([startedAt])
}

enum PipelineStep {
  SCRAPE
  SYNTHESIS
  PUBLISH
}

enum RunStatus {
  RUNNING
  COMPLETED
  FAILED
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
